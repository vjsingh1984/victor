[pytest]
# Pytest configuration for Victor AI
# All pytest settings live in this file to avoid config precedence warnings.

# Test discovery patterns
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# Test paths
testpaths = tests

# Minimum version
minversion = 8.0

# Add options
addopts =
    # Strict markers and config
    --strict-markers
    --strict-config

    # Completely ignore load tests and benchmarks during collection
    # (much faster than marker-based exclusion)
    --ignore=tests/load_test
    --ignore=tests/benchmark

    # Exclude slow tests by default
    -m "not slow"

    # NOTE: Coverage disabled by default to prevent hanging on async tests.
    # Use --cov flag or run 'make test-cov' to enable coverage.
    # For CI/CD, use pytest-ci.ini which has coverage enabled.

    # Verbose output
    -v

    # Show locals on tracebacks (DISABLED - causes slow test execution)
    # --showlocals

    # Shorter traceback format
    --tb=short

    # Disable warnings (can be enabled with -W default)
    --disable-warnings

    # Capture output (can be disabled with -s)
    --capture=fd

    # Do not capture stderr/stdout (for debugging)
    # --capture=no

    # Test timeout (requires pytest-timeout)
    # --timeout=10

    # Parallel execution (requires pytest-xdist)
    # -n auto

    # Fail on warnings during collection
    # -W error

# Asyncio mode
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# Test timeout configuration (requires pytest-timeout)
timeout = 300
# timeout_method = thread  # Deprecated: Use 'signal' or remove (default is 'signal')

# Markers
markers =
    # Test type markers
    unit: Unit tests (fast, isolated)
    integration: Integration tests (require external services)
    smoke: Smoke tests (quick sanity checks)
    regression: Regression tests

    # Test characteristic markers
    slow: Slow tests (deselect with '-m "not slow"')
    requires_network: Tests requiring network access
    requires_ollama: Tests requiring Ollama server
    requires_docker: Tests requiring Docker daemon

    # Feature-specific markers
    workflows: Workflow-related tests
    agents: Multi-agent tests
    hitl: Human-in-the-loop tests
    benchmark: Performance benchmarks
    summary: Summary/report generation tests
    load_test: Load and scalability tests (require load testing infrastructure)

    # Provider-specific markers
    requires_anthropic: Tests requiring Anthropic API
    requires_openai: Tests requiring OpenAI API
    requires_google: Tests requiring Google API

    # Database markers
    requires_database: Tests requiring database connection
    requires_cache: Tests requiring cache backend

# Logging configuration
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = false
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] %(filename)s:%(lineno)d - %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Filter warnings
filterwarnings =
    # Ignore pytest collection warnings for classes starting with "Test"
    ignore:cannot collect test class.*because it has a __init__ constructor:pytest.PytestCollectionWarning

    # Ignore semaphore leak warnings (from dependencies)
    ignore:.*semaphore.*:ResourceWarning
    ignore:.*leaked.*semaphore.*:UserWarning
    ignore:.*resource_tracker.*:UserWarning

    # Ignore deprecation warnings from dependencies
    ignore:.*DeprecationWarning:DeprecationWarning

    # Ignore asyncio warnings in test environment
    ignore:.*asyncio.*:DeprecationWarning

# Test ordering (requires pytest-order)
# order-scope = session
# order-dependencies = true

# Coverage settings (see pyproject.toml for full config)
[coverage:run]
source = victor
omit =
    */tests/*
    */__init__.py
    victor/ui/cli.py
    victor/ui/commands.py
parallel = true
context = test

[coverage:report]
precision = 2
show_missing = true
skip_covered = false
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstractmethod

[coverage:html]
directory = htmlcov

[coverage:xml]
output = coverage.xml
