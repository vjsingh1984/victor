# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Mode-Based Workflows for Agent Operational Modes
# ================================================
# These workflows define the execution patterns for BUILD, PLAN, and EXPLORE modes.
# Each mode has a distinct workflow with different tool budgets, allowed tools,
# and exploration depths.

workflows:
  # =========================================================================
  # EXPLORE Mode Workflow
  # =========================================================================
  explore:
    description: "Exploration mode for understanding code without modifications"
    metadata:
      mode: explore
      exploration_multiplier: 3.0
      sandbox_only: true
    nodes:
      - id: gather_context
        type: agent
        role: explorer
        goal: "Gather initial context about the codebase structure and files"
        tool_budget: 15
        allowed_tools:
          - read
          - grep
          - ls
          - glob
          - code_search
          - semantic_search
          - symbols
        next:
          - analyze_architecture

      - id: analyze_architecture
        type: agent
        role: analyst
        goal: "Analyze codebase architecture, patterns, and dependencies"
        tool_budget: 20
        allowed_tools:
          - read
          - grep
          - symbols
          - code_search
          - semantic_search
        next:
          - document_findings

      - id: document_findings
        type: agent
        role: writer
        goal: "Document findings in sandbox notes without modifying codebase"
        tool_budget: 5
        allowed_tools:
          - read
          - write  # Only to .victor/sandbox/
        sandbox_dir: ".victor/sandbox"

  # =========================================================================
  # PLAN Mode Workflow
  # =========================================================================
  plan:
    description: "Planning mode for designing implementation strategy"
    metadata:
      mode: plan
      exploration_multiplier: 2.5
      sandbox_only: true
      verbose_planning: true
    nodes:
      - id: understand_requirements
        type: agent
        role: analyst
        goal: "Understand the task requirements and constraints"
        tool_budget: 10
        allowed_tools:
          - read
          - grep
          - code_search
          - semantic_search
        next:
          - explore_codebase

      - id: explore_codebase
        type: agent
        role: explorer
        goal: "Explore relevant parts of the codebase for the task"
        tool_budget: 25
        allowed_tools:
          - read
          - grep
          - ls
          - glob
          - code_search
          - semantic_search
          - symbols
        next:
          - identify_changes

      - id: identify_changes
        type: agent
        role: architect
        goal: "Identify files that need changes and plan modifications"
        tool_budget: 15
        allowed_tools:
          - read
          - grep
          - symbols
          - code_search
        next:
          - design_approach

      - id: design_approach
        type: agent
        role: architect
        goal: "Design the implementation approach with step-by-step plan"
        tool_budget: 10
        allowed_tools:
          - read
        next:
          - review_plan

      - id: review_plan
        type: hitl
        hitl_type: approval
        prompt: "Review the implementation plan. Approve to continue or provide feedback."
        timeout: 600
        fallback: "abort"
        next:
          - create_plan_doc

      - id: create_plan_doc
        type: agent
        role: writer
        goal: "Create a detailed plan document in sandbox"
        tool_budget: 5
        allowed_tools:
          - read
          - write  # Only to .victor/sandbox/
        sandbox_dir: ".victor/sandbox"

  # =========================================================================
  # BUILD Mode Workflow
  # =========================================================================
  build:
    description: "Implementation mode for creating and modifying code"
    metadata:
      mode: build
      exploration_multiplier: 1.0
      allow_all_tools: true
    nodes:
      - id: quick_context
        type: agent
        role: reader
        goal: "Quickly gather essential context for the task"
        tool_budget: 10
        allowed_tools:
          - read
          - grep
          - ls
          - code_search
        next:
          - implement_changes

      - id: implement_changes
        type: agent
        role: implementer
        goal: "Implement the required changes efficiently"
        tool_budget: 30
        allowed_tools:
          - read
          - write
          - edit
          - shell
          - grep
          - ls
        next:
          - run_tests

      - id: run_tests
        type: agent
        role: tester
        goal: "Run tests to verify changes"
        tool_budget: 10
        allowed_tools:
          - shell
          - read
        next:
          - check_tests

      - id: check_tests
        type: condition
        condition: "tests_passed"
        branches:
          true: finalize
          false: fix_issues

      - id: fix_issues
        type: agent
        role: debugger
        goal: "Fix any test failures or issues"
        tool_budget: 20
        allowed_tools:
          - read
          - edit
          - shell
          - grep
        next:
          - run_tests

      - id: finalize
        type: agent
        role: reviewer
        goal: "Finalize changes and prepare for commit"
        tool_budget: 5
        allowed_tools:
          - shell
          - read

  # =========================================================================
  # Compound Workflows (Multi-Agent Teams)
  # =========================================================================
  explore_plan_build:
    description: "Complete workflow from exploration to implementation"
    metadata:
      compound: true
      phases: ["explore", "plan", "build"]
    nodes:
      - id: exploration_phase
        type: parallel
        parallel_nodes:
          - architecture_analysis
          - dependency_mapping
        join_strategy: all
        next:
          - planning_phase

      - id: architecture_analysis
        type: agent
        role: architect
        goal: "Analyze overall architecture and design patterns"
        tool_budget: 15
        allowed_tools:
          - read
          - grep
          - symbols
          - code_search

      - id: dependency_mapping
        type: agent
        role: analyst
        goal: "Map dependencies and identify affected areas"
        tool_budget: 15
        allowed_tools:
          - read
          - grep
          - semantic_search
          - code_search

      - id: planning_phase
        type: agent
        role: planner
        goal: "Create detailed implementation plan based on exploration"
        tool_budget: 10
        allowed_tools:
          - read
          - grep
        next:
          - implementation_phase

      - id: implementation_phase
        type: agent
        role: implementer
        goal: "Execute the implementation plan"
        tool_budget: 40
        next:
          - verification

      - id: verification
        type: agent
        role: verifier
        goal: "Verify implementation meets requirements"
        tool_budget: 10
