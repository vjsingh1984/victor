# Deep Research Workflow
# ======================
# Multi-stage research with:
# - Source discovery and validation
# - Information extraction and synthesis
# - Citation management
# - Report generation
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ EXECUTION ENVIRONMENT                                                        │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ Default: in-process (Python) + LLM API calls                                │
# │ Supported: in-process only (no subprocess/docker needed)                    │
# │                                                                              │
# │ Requirements:                                                                │
# │   - LLM provider API access (for agent nodes)                               │
# │   - Network access (for web searches and fetches)                           │
# │   - Write access (for report output)                                        │
# │                                                                              │
# │ Network requirements:                                                        │
# │   - web_search: External search APIs (Google, Bing)                         │
# │   - web_fetch: HTTP requests to extract content from URLs                   │
# │   - Academic searches require access to scholar sites                       │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ DEFAULT VALUES                                                               │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ coverage_threshold: 0.7 (70% topic coverage before synthesis)               │
# │ citation_format: APA (default, supports MLA, Chicago, IEEE)                 │
# │ max_search_queries: 10 per source type                                      │
# │ source_quality_threshold: 0.6 (minimum credibility score)                   │
# │ hitl_timeout: 600s (10 min for gap decisions)                               │
# │ report_max_tokens: 8000 (final report length limit)                         │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ COMPUTE vs AGENT NODE RATIONALE                                              │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ COMPUTE nodes (no LLM reasoning):                                            │
# │   - generate_citations: Text formatting with citation templates              │
# │     (Rules: APA/MLA/Chicago patterns applied to structured source data)     │
# │                                                                              │
# │ AGENT nodes (require LLM reasoning):                                         │
# │   - understand_query: INTERPRETING research question semantics              │
# │   - create_search_plan: PLANNING multi-step search strategy                 │
# │   - web_search/academic_search/code_search: EVALUATING search results       │
# │   - validate_sources: JUDGING credibility and bias                          │
# │   - gap_analysis: ANALYZING what's missing from research                    │
# │   - synthesize: INTEGRATING findings into coherent narrative                │
# │   - generate_report: WRITING professional research document                 │
# │                                                                              │
# │ Research is inherently knowledge work - most steps require LLM:             │
# │   - Understanding query intent and nuance                                   │
# │   - Evaluating source quality and relevance                                 │
# │   - Synthesizing information across multiple sources                        │
# │   - Writing cohesive reports with proper attribution                        │
# └─────────────────────────────────────────────────────────────────────────────┘

workflows:
  deep_research:
    description: "Comprehensive research with source validation and synthesis"

    metadata:
      version: "1.0"
      author: "victor"
      vertical: research

    nodes:
      # =====================================================================
      # Stage 1: Research Planning
      # =====================================================================
      - id: understand_query
        type: agent
        name: "Understand Research Query"
        role: researcher
        goal: |
          Analyze the research query to understand:
          1. The core question being asked
          2. Key concepts and terms to search for
          3. Scope and depth required
          4. Types of sources needed (academic, industry, news)
        tool_budget: 10
        llm_config:
          temperature: 0.3
        output: query_analysis
        next: [create_search_plan]

      - id: create_search_plan
        type: agent
        name: "Create Search Plan"
        role: planner
        goal: |
          Create a comprehensive search plan:
          1. Define search queries for different aspects
          2. Identify key sources to check
          3. Prioritize search order
          4. Set quality criteria for sources
        tool_budget: 10
        input_mapping:
          analysis: query_analysis
        output: search_plan
        next: [parallel_search]

      # =====================================================================
      # Stage 2: Source Discovery (Parallel)
      # =====================================================================
      - id: parallel_search
        type: parallel
        name: "Parallel Source Discovery"
        parallel_nodes: [web_search, academic_search, code_search]
        join_strategy: all
        next: [aggregate_sources]

      - id: web_search
        type: agent
        name: "Web Search"
        role: researcher
        goal: |
          Search the web for relevant information:
          - Use search queries from the plan
          - Evaluate source credibility
          - Extract key information
          - Note URLs for citations
        tool_budget: 30
        tools: [web_search, web_fetch, read]
        llm_config:
          temperature: 0.2
        output: web_results

      - id: academic_search
        type: agent
        name: "Academic Search"
        role: researcher
        goal: |
          Search for academic and research sources:
          - Look for peer-reviewed papers
          - Check authoritative publications
          - Note authors and institutions
        tool_budget: 25
        tools: [web_search, web_fetch]
        llm_config:
          temperature: 0.2
        output: academic_results

      - id: code_search
        type: agent
        name: "Code and Documentation Search"
        role: researcher
        goal: |
          Search for technical documentation and code examples:
          - Check official documentation
          - Find relevant GitHub repositories
          - Look for implementation examples
        tool_budget: 20
        tools: [web_search, web_fetch, read]
        output: code_results

      - id: aggregate_sources
        type: transform
        name: "Aggregate All Sources"
        transform: |
          all_sources = merge(web_results, academic_results, code_results)
          source_count = len(all_sources)
        next: [validate_sources]

      # =====================================================================
      # Stage 3: Source Validation
      # =====================================================================
      - id: validate_sources
        type: agent
        name: "Validate Source Quality"
        role: analyst
        goal: |
          Evaluate the quality and relevance of gathered sources:
          1. Check source credibility (author, publication, date)
          2. Verify information accuracy where possible
          3. Identify potential biases
          4. Rank sources by reliability
          5. Flag any conflicting information
        tool_budget: 20
        llm_config:
          temperature: 0.3
        input_mapping:
          sources: all_sources
        output: validated_sources
        next: [check_coverage]

      - id: check_coverage
        type: condition
        name: "Check Topic Coverage"
        condition: "coverage_score >= 0.7"
        branches:
          "true": synthesize
          "false": gap_analysis

      - id: gap_analysis
        type: agent
        name: "Identify Information Gaps"
        role: analyst
        goal: |
          Identify gaps in the research:
          - What aspects haven't been covered?
          - What questions remain unanswered?
          - What additional sources are needed?
        tool_budget: 10
        output: gaps
        next: [request_more_research]

      - id: request_more_research
        type: hitl
        name: "Request Additional Research"
        hitl_type: input
        prompt: |
          ## Research Gaps Identified

          **Current Coverage:** {coverage_score}%

          **Missing Information:**
          {gaps}

          Should we:
          1. Continue with available information
          2. Search for additional sources
          3. Adjust research scope
        context_keys:
          - coverage_score
          - gaps
        timeout: 600
        fallback: continue
        next: [handle_gap_decision]

      - id: handle_gap_decision
        type: condition
        name: "Handle Gap Decision"
        condition: "gap_decision"
        branches:
          "continue": synthesize
          "search_more": parallel_search
          "adjust": understand_query

      # =====================================================================
      # Stage 4: Synthesis
      # =====================================================================
      - id: synthesize
        type: agent
        name: "Synthesize Findings"
        role: analyst
        goal: |
          Synthesize all research findings:
          1. Identify key themes and patterns
          2. Reconcile conflicting information
          3. Draw conclusions based on evidence
          4. Note limitations and caveats
          5. Suggest areas for further research
        tool_budget: 25
        llm_config:
          temperature: 0.4
        input_mapping:
          sources: validated_sources
        output: synthesis
        next: [generate_citations]

      # COMPUTE: Citation formatting is template-based text manipulation
      # ─────────────────────────────────────────────────────────────────────
      # Algorithm: Apply citation style rules to structured source metadata
      # Formats: APA, MLA, Chicago, IEEE - each has deterministic patterns
      # Input: Source objects with author, year, title, URL, publisher, etc.
      # Output: Formatted citation strings in requested style
      #
      # WHY COMPUTE: No semantic understanding needed - pure pattern matching:
      #   - APA: Author, A. A. (Year). Title. Publisher.
      #   - MLA: Author. "Title." Publisher, Year.
      #   - Rules are mechanical, not interpretive
      #
      # Execution: in-process (Python string formatting)
      # BLOCKED: [llm, write] - read-only formatting, no network needed
      - id: generate_citations
        type: compute
        name: "Generate Citations"
        handler: citation_formatter
        inputs:
          sources: $ctx.validated_sources
          format: $ctx.citation_format
        output: citations
        constraints: [llm, write]
        timeout: 60
        next: [review_synthesis]

      - id: review_synthesis
        type: hitl
        name: "Review Synthesis"
        hitl_type: approval
        prompt: |
          ## Research Synthesis Complete

          **Key Findings:**
          {synthesis_summary}

          **Sources Used:** {source_count}
          **Citation Format:** {citation_format}

          Approve for final report generation?
        context_keys:
          - synthesis_summary
          - source_count
          - citation_format
        timeout: 900
        fallback: continue
        next: [generate_report]

      # =====================================================================
      # Stage 5: Report Generation
      # =====================================================================
      - id: generate_report
        type: agent
        name: "Generate Research Report"
        role: reviewer
        goal: |
          Generate a comprehensive research report:

          Structure:
          1. Executive Summary
          2. Introduction and Background
          3. Methodology
          4. Findings (organized by theme)
          5. Analysis and Discussion
          6. Conclusions
          7. Recommendations
          8. References

          Guidelines:
          - Use clear, professional language
          - Support claims with citations
          - Include relevant examples
          - Note limitations
        tool_budget: 30
        tools: [write]
        llm_config:
          temperature: 0.5
          max_tokens: 8000
        input_mapping:
          synthesis: synthesis
          citations: citations
        output: final_report
        next: [complete]

      - id: complete
        type: transform
        name: "Research Complete"
        transform: |
          status = "completed"
          completion_time = current_timestamp()


  # =========================================================================
  # Quick Research
  # =========================================================================
  quick_research:
    description: "Fast research for simple queries"

    metadata:
      vertical: research

    nodes:
      - id: quick_search
        type: agent
        name: "Quick Search"
        role: researcher
        goal: |
          Quickly research the query:
          - Search for relevant information
          - Summarize key findings
          - Note sources
        tool_budget: 20
        tools: [web_search, web_fetch]
        llm_config:
          temperature: 0.3
          model_hint: claude-3-sonnet
        output: findings
        next: [quick_summary]

      - id: quick_summary
        type: agent
        name: "Generate Summary"
        role: reviewer
        goal: "Summarize the research findings in 2-3 paragraphs."
        tool_budget: 5
        llm_config:
          temperature: 0.4
          model_hint: claude-3-haiku
        output: summary
