# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""{{ name_title }} vertical service provider for DI container registration.

This module registers {{ name }}-specific services with the DI container,
enabling the framework to resolve {{ name }} vertical dependencies.
"""

from __future__ import annotations

import logging
from typing import TYPE_CHECKING, List, Type

from victor.core.verticals.protocols import ServiceProviderProtocol

if TYPE_CHECKING:
    from victor.core.container import ServiceContainer
    from victor.config.settings import Settings

logger = logging.getLogger(__name__)


# Protocol definitions for {{ name }} services (for type checking)
class {{ name_class }}SafetyProtocol:
    """Protocol for {{ name }} safety extension."""

    pass


class {{ name_class }}PromptProtocol:
    """Protocol for {{ name }} prompt contributor."""

    pass


class {{ name_class }}ServiceProvider(ServiceProviderProtocol):
    """Service provider for {{ name }} vertical.

    Registers {{ name }}-specific services with the DI container:
    - {{ name_class }}SafetyExtension for safety patterns
    - {{ name_class }}PromptContributor for task hints
    - {{ name_class }}ModeConfigProvider for mode configurations
    """

    def register_services(
        self,
        container: "ServiceContainer",
        settings: "Settings",
    ) -> None:
        """Register {{ name }}-specific services.

        Args:
            container: DI container to register services in
            settings: Application settings
        """
        from victor.core.container import ServiceLifetime

        # Register {{ name_class }}SafetyExtension
        self._register_safety(container, settings)

        # Register {{ name_class }}PromptContributor
        self._register_prompts(container, settings)

        # Register {{ name_class }}ModeConfigProvider
        self._register_mode_config(container, settings)

        logger.info("Registered {{ name }} vertical services")

    def _register_safety(
        self,
        container: "ServiceContainer",
        settings: "Settings",
    ) -> None:
        """Register {{ name }} safety extension."""
        from victor.core.container import ServiceLifetime

        def create_safety(_):
            from victor.{{ name }}.safety import {{ name_class }}SafetyExtension

            return {{ name_class }}SafetyExtension()

        container.register_or_replace(
            {{ name_class }}SafetyProtocol,
            create_safety,
            ServiceLifetime.SINGLETON,
        )

    def _register_prompts(
        self,
        container: "ServiceContainer",
        settings: "Settings",
    ) -> None:
        """Register {{ name }} prompt contributor."""
        from victor.core.container import ServiceLifetime

        def create_prompts(_):
            from victor.{{ name }}.prompts import {{ name_class }}PromptContributor

            return {{ name_class }}PromptContributor()

        container.register_or_replace(
            {{ name_class }}PromptProtocol,
            create_prompts,
            ServiceLifetime.SINGLETON,
        )

    def _register_mode_config(
        self,
        container: "ServiceContainer",
        settings: "Settings",
    ) -> None:
        """Register mode configuration provider."""
        from victor.core.container import ServiceLifetime
        from victor.core.verticals.protocols import ModeConfigProviderProtocol

        def create_mode_config(_):
            from victor.{{ name }}.mode_config import {{ name_class }}ModeConfigProvider

            return {{ name_class }}ModeConfigProvider()

        container.register_or_replace(
            ModeConfigProviderProtocol,
            create_mode_config,
            ServiceLifetime.SINGLETON,
        )

    def get_required_services(self) -> List[Type]:
        """Get list of required service types.

        Returns:
            List of protocol types this vertical requires
        """
        return []  # No hard requirements

    def get_optional_services(self) -> List[Type]:
        """Get list of optional service types.

        Returns:
            List of optional protocol types
        """
        from victor.core.verticals.protocols import ModeConfigProviderProtocol

        return [
            {{ name_class }}SafetyProtocol,
            {{ name_class }}PromptProtocol,
            ModeConfigProviderProtocol,
        ]


__all__ = [
    "{{ name_class }}ServiceProvider",
    "{{ name_class }}SafetyProtocol",
    "{{ name_class }}PromptProtocol",
]
