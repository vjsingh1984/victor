# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
# SPDX-License-Identifier: Apache-2.0

# Victor Core - Minimal LLM Orchestration Image
# This image contains only the core framework without coding-specific tools
# Significantly smaller than the full image (~500MB vs ~2GB)

FROM python:3.12-slim

LABEL maintainer="Vijaykumar Singh <singhvjd@gmail.com>"
LABEL description="Victor Core - Minimal LLM Orchestration"
LABEL version="0.3.0"

# Install minimal system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN useradd -m -u 1000 victor && \
    mkdir -p /home/victor/.victor && \
    chown -R victor:victor /home/victor

WORKDIR /app

# Copy packages
COPY packages/victor-core ./packages/victor-core
COPY packages/pyproject.toml ./packages/

# Install only victor-core (no Tree-sitter, no LSP, no coding tools)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir ./packages/victor-core

# Switch to non-root user
USER victor

# Environment
ENV PYTHONUNBUFFERED=1
ENV VICTOR_HOME=/home/victor/.victor

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import victor; print(victor.__version__)" || exit 1

# Default: run as API server
CMD ["python", "-m", "victor.ui.cli", "serve", "--port", "8765"]
