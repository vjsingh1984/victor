# Combined Validation Workflow - FEP and Vertical validation
# Only runs when relevant files change

name: Validation

on:
  pull_request:
    paths:
      - 'feps/**'
      - 'victor/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # FEP Validation - runs in parallel with vertical validation
  fep-validation:
    name: Validate FEPs
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: contains(github.event.head_commit.modified, 'feps/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-validation-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-validation-
            ${{ runner.os }}-pip-

      - name: Install Victor
        run: |
          pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      - name: Find modified FEP files
        id: find-feps
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          FEP_FILES=$(git diff --name-only --diff-filter=AM origin/${BASE_BRANCH}...HEAD | grep '^feps/fep-.*\.md$' || true)

          if [ -z "$FEP_FILES" ]; then
            echo "No FEP files modified"
            echo "fep_files=" >> $GITHUB_OUTPUT
          else
            echo "$FEP_FILES"
            FEP_LIST=$(echo "$FEP_FILES" | tr '\n' ' ' | sed 's/ $//')
            echo "fep_files=$FEP_LIST" >> $GITHUB_OUTPUT
          fi

      - name: Validate FEPs
        if: steps.find-feps.outputs.fep_files != ''
        run: |
          FEP_FILES="${{ steps.find-feps.outputs.fep_files }}"
          VALIDATION_FAILED=0

          for fep_file in $FEP_FILES; do
            echo "Validating: $fep_file"
            if victor fep validate "$fep_file"; then
              echo "✓ $fep_file is valid"
            else
              echo "✗ $fep_file validation failed"
              VALIDATION_FAILED=1
            fi
          done

          if [ $VALIDATION_FAILED -ne 0 ]; then
            exit 1
          fi

  # Vertical Validation - runs in parallel with FEP validation
  vertical-validation:
    name: Validate Verticals
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: contains(github.event.head_commit.modified, 'victor/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-validation-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-validation-
            ${{ runner.os }}-pip-

      - name: Install Victor
        run: |
          pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -e ".[dev]"

      - name: Find modified vertical directories
        id: find-verticals
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          MODIFIED_DIRS=$(git diff --name-only --diff-filter=AM origin/${BASE_BRANCH}...HEAD | \
            grep '^victor/[^/]+/' | \
            sed 's|victor/[^/]*/||' | \
            cut -d'/' -f1 | \
            sort -u || true)

          VERTICAL_DIRS=""
          for dir in $MODIFIED_DIRS; do
            if [ -f "victor/$dir/victor-vertical.toml" ]; then
              VERTICAL_DIRS="$VERTICAL_DIRS victor/$dir"
            fi
          done

          if [ -z "$VERTICAL_DIRS" ]; then
            echo "vertical_dirs=" >> $GITHUB_OUTPUT
          else
            echo "vertical_dirs=$VERTICAL_DIRS" >> $GITHUB_OUTPUT
          fi

      - name: Validate vertical metadata
        if: steps.find-verticals.outputs.vertical_dirs != ''
        run: |
          VERTICAL_DIRS="${{ steps.find-verticals.outputs.vertical_dirs }}"
          VALIDATION_FAILED=0

          for vertical_dir in $VERTICAL_DIRS; do
            VERTICAL_NAME=$(basename "$vertical_dir")
            TOML_FILE="$vertical_dir/victor-vertical.toml"

            echo "Validating: $VERTICAL_NAME"

            python - <<EOF
          from pathlib import Path
          from victor.core.verticals.package_schema import VerticalPackageMetadata
          metadata = VerticalPackageMetadata.from_toml(Path("$TOML_FILE"))
          print(f"✓ {metadata.name} v{metadata.version}")
          EOF

            if [ $? -ne 0 ]; then
              VALIDATION_FAILED=1
            fi
          done

          if [ $VALIDATION_FAILED -ne 0 ]; then
            exit 1
          fi

  # Post validation results as PR comment
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [fep-validation, vertical-validation]
    if: always()
    steps:
      - name: Create summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const fepResult = '${{ needs.fep-validation.result }}';
            const verticalResult = '${{ needs.vertical-validation.result }}';

            let body = '## Validation Results\n\n';
            body += `**FEP Validation**: ${fepResult === 'success' ? '✅ Passed' : fepResult === 'skipped' ? '⏭️ Skipped' : '❌ Failed'}\n`;
            body += `**Vertical Validation**: ${verticalResult === 'success' ? '✅ Passed' : verticalResult === 'skipped' ? '⏭️ Skipped' : '❌ Failed'}\n`;

            if (context.eventName === 'pull_request') {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Validation Results')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body,
                });
              }
            }
