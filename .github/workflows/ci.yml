# Main CI Workflow - Orchestrates all CI jobs
# This workflow coordinates running the specialized CI workflows

name: CI - Main

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Trigger fast checks - runs in ~1-2 minutes
  trigger-fast-checks:
    name: Trigger Fast Checks
    runs-on: ubuntu-latest
    outputs:
      fast-checks-status: ${{ steps.wait-for-fast.result }}
    steps:
      - name: Wait for fast checks
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Format Check (Black)'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
        id: wait-for-fast
        continue-on-error: true

  # Trigger tests - runs in parallel with fast checks
  trigger-tests:
    name: Trigger Tests
    runs-on: ubuntu-latest
    steps:
      - name: Wait for tests
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Test Summary'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
        continue-on-error: true

  # Build artifacts - only after tests pass
  trigger-build:
    name: Trigger Build
    runs-on: ubuntu-latest
    needs: [trigger-fast-checks, trigger-tests]
    if: github.event_name == 'push' || contains(github.event.head_commit.message, '[build]')
    steps:
      - name: Wait for build
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.sha }}
          check-name: 'Build Summary'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
        continue-on-error: true

  # CI Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [trigger-fast-checks, trigger-tests, trigger-build]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fast Checks | ${{ needs.trigger-fast-checks.result == 'success' && '✅ Passed' || '⏳ In Progress' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.trigger-tests.result == 'success' && '✅ Passed' || '⏳ In Progress' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.trigger-build.result == 'success' && '✅ Passed' || needs.trigger-build.result == 'skipped' && '⏭️ Skipped' || '⏳ In Progress' }} |" >> $GITHUB_STEP_SUMMARY
