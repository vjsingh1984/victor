# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Infrastructure CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'config/k8s/**'
      - 'config/helm/**'
      - 'scripts/ci/**'
      - '.github/workflows/infrastructure-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - 'config/k8s/**'
      - 'config/helm/**'
      - 'scripts/ci/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Validate Dockerfiles
  # ==========================================================================
  validate-dockerfiles:
    name: Validate Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Dockerfile syntax
        run: |
          # Check main Dockerfile
          docker build --check -f Dockerfile .

          # Check production Dockerfile
          docker build --check -f Dockerfile.production .

      - name: Run Hadolint on Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile.production
          ignore: DL3008,DL3013  # Ignore certain rules
          failure-threshold: warning

      - name: Check .dockerignore
        run: |
          if [ ! -f .dockerignore ]; then
            echo "Warning: .dockerignore not found"
            exit 1
          fi
          echo ".dockerignore exists"

      - name: Validate multi-stage build
        run: |
          # Ensure production Dockerfile uses multi-stage build
          if ! grep -q "FROM.*AS builder" Dockerfile.production; then
            echo "Error: Production Dockerfile must use multi-stage build"
            exit 1
          fi
          echo "✓ Multi-stage build detected"

  # ==========================================================================
  # Build Docker images (dry run)
  # ==========================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate-dockerfiles
    strategy:
      matrix:
        dockerfile:
          - Dockerfile
          - Dockerfile.production
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false
          load: true
          tags: victor:test-${{ matrix.dockerfile }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=test
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}

      - name: Test basic functionality
        run: |
          # Run container
          docker run --rm victor:test-${{ matrix.dockerfile }} victor --version

          # Check non-root user
          USER=$(docker run --rm victor:test-${{ matrix.dockerfile }} whoami)
          if [ "$USER" != "victor" ]; then
            echo "Error: Container should run as non-root user"
            exit 1
          fi
          echo "✓ Running as non-root user: $USER"

      - name: Check image size
        run: |
          SIZE=$(docker images victor:test-${{ matrix.dockerfile }} --format "{{.Size}}")
          echo "Image size: $SIZE"

          # Parse size (e.g., "1.2GB" or "850MB")
          SIZE_NUM=$(echo $SIZE | grep -oE '[0-9.]+')

          # Warn if > 1GB
          if (( $(echo "$SIZE_NUM > 1.0" | bc -l) )); then
            echo "⚠️  Warning: Image size exceeds 1GB"
          else
            echo "✓ Image size is under 1GB"
          fi

  # ==========================================================================
  # Validate Kubernetes manifests
  # ==========================================================================
  validate-k8s:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Validate Kubernetes manifests
        run: |
          # Validate all YAML manifests
          for file in config/k8s/*.yaml; do
            echo "Validating $file..."
            kubectl apply --dry-run=client -f "$file"
          done
          echo "✓ All Kubernetes manifests are valid"

      - name: Check for common issues
        run: |
          # Ensure namespace is defined
          if ! grep -q "name: victor" config/k8s/namespace.yaml; then
            echo "Error: Namespace not defined correctly"
            exit 1
          fi

          # Check resource limits
          if ! grep -q "resources:" config/k8s/deployment.yaml; then
            echo "Warning: No resource limits defined in deployment"
          fi

          # Check health probes
          if ! grep -q "livenessProbe" config/k8s/deployment.yaml; then
            echo "Warning: No liveness probe defined"
          fi

          echo "✓ K8s manifest validation complete"

  # ==========================================================================
  # Validate Helm chart
  # ==========================================================================
  validate-helm:
    name: Validate Helm Chart
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Lint Helm chart
        run: |
          helm lint ./config/helm/victor

      - name: Validate Helm templates
        run: |
          # Template render test
          helm template victor ./config/helm/victor --debug > /dev/null

          # Dry-run install
          helm install victor ./config/helm/victor --dry-run --debug

          echo "✓ Helm chart is valid"

      - name: Check Helm chart version
        run: |
          # Extract version from Chart.yaml
          CHART_VERSION=$(grep "^version:" config/helm/victor/Chart.yaml | awk '{print $2}')
          echo "Helm chart version: $CHART_VERSION"

          # Check if version matches app version (optional)
          APP_VERSION=$(grep "^appVersion:" config/helm/victor/Chart.yaml | awk '{print $2}')
          echo "App version: $APP_VERSION"

  # ==========================================================================
  # Validate docker-compose files
  # ==========================================================================
  validate-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose syntax
        run: |
          # Validate main compose file
          docker-compose -f docker-compose.yml config

          # Validate production compose file
          docker-compose -f docker-compose.production.yml config

          echo "✓ All docker-compose files are valid"

      - name: Check for production best practices
        run: |
          # Check for restart policies
          if ! grep -q "restart:" docker-compose.production.yml; then
            echo "Warning: No restart policies in production compose"
          fi

          # Check for health checks
          if ! grep -q "healthcheck:" docker-compose.production.yml; then
            echo "Warning: No health checks in production compose"
          fi

          # Check for resource limits
          if ! grep -q "mem_limit" docker-compose.production.yml && ! grep -q "deploy:" docker-compose.production.yml; then
            echo "Warning: No resource limits in production compose"
          fi

          echo "✓ Docker Compose validation complete"

  # ==========================================================================
  # Security scanning
  # ==========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-docker
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.production
          push: false
          load: true
          tags: victor:security-scan
          cache-from: type=gha

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: victor:security-scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Docker Bench Security
        uses: docker/docker-bench-security-action@master
        with:
          image: victor:security-scan
          format: json
          output: docker-bench-results.json
        continue-on-error: true

  # ==========================================================================
  # Infrastructure summary
  # ==========================================================================
  summary:
    name: Infrastructure Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-dockerfiles, build-docker, validate-k8s, validate-helm, validate-compose, security-scan]
    steps:
      - name: Generate summary
        run: |
          cat > infrastructure-summary.md << 'EOF'
          # Infrastructure CI Summary

          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}

          ## Validation Results

          - Dockerfile Validation: ${{ needs.validate-dockerfiles.result }}
          - Docker Build: ${{ needs.build-docker.result }}
          - Kubernetes Manifests: ${{ needs.validate-k8s.result }}
          - Helm Chart: ${{ needs.validate-helm.result }}
          - Docker Compose: ${{ needs.validate-compose.result }}
          - Security Scan: ${{ needs.security-scan.result }}

          ## Checks Performed

          ✓ Dockerfile syntax validation
          ✓ Multi-stage build optimization
          ✓ Non-root user enforcement
          ✓ Image size check (< 1GB)
          ✓ Kubernetes manifest validation
          ✓ Helm chart linting
          ✓ Docker Compose validation
          ✓ Security vulnerability scanning
          ✓ Docker Bench compliance

          ## Next Steps

          - Review any failed checks above
          - Address security vulnerabilities
          - Optimize image size if needed
          - Test deployment locally before merging

          ## Documentation

          - [Infrastructure Guide](docs/INFRASTRUCTURE.md)
          - [Deployment Guide](docs/operations/deployment.md)
          - [Kubernetes Manifests](config/k8s/)
          - [Helm Chart](config/helm/victor/)
          EOF

          cat infrastructure-summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-summary
          path: infrastructure-summary.md

      - name: Add to job summary
        run: cat infrastructure-summary.md >> $GITHUB_STEP_SUMMARY
