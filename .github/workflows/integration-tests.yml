# GitHub Actions workflow for integration tests with multi-provider support
#
# This workflow demonstrates how to run real execution integration tests
# with multiple cloud providers. Tests are automatically skipped when API keys
# are not available, making it safe to run in public repositories.

name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

env:
  # Python version
  PYTHON_VERSION: "3.12"

jobs:
  # Local provider tests (Ollama)
  ollama-tests:
    name: Ollama Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5
          ollama pull qwen2.5-coder:7b

      - name: Run Ollama integration tests
        run: |
          pytest tests/integration/real_execution/test_real_tool_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "ollama or not (deepseek or xai or mistral or openai)"

      - name: Run multi-provider tests
        run: |
          pytest tests/integration/real_execution/test_multi_provider_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "ollama or not (deepseek or xai or mistral or openai)"

  # DeepSeek tests (only if API key is available)
  deepseek-tests:
    name: DeepSeek Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run if API key is set in GitHub Secrets
    if: secrets.DEEPSEEK_API_KEY != ''

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run DeepSeek tests
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          pytest tests/integration/real_execution/test_multi_provider_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "deepseek"
        # Note: Tests will be skipped if DEEPSEEK_API_KEY is not set

  # xAI tests (only if API key is available)
  xai-tests:
    name: xAI Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: secrets.XAI_API_KEY != ''

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run xAI tests
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          pytest tests/integration/real_execution/test_multi_provider_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "xai"

  # Mistral tests (only if API key is available)
  mistral-tests:
    name: Mistral Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: secrets.MISTRAL_API_KEY != ''

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Mistral tests
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        run: |
          pytest tests/integration/real_execution/test_multi_provider_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "mistral"

  # OpenAI tests (only if API key is available)
  openai-tests:
    name: OpenAI Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: secrets.OPENAI_API_KEY != ''

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run OpenAI tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          pytest tests/integration/real_execution/test_multi_provider_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "openai"

  # ZAI tests (only if API key is available)
  zai-tests:
    name: ZAI Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: secrets.ZAI_API_KEY != ''

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ZAI tests
        env:
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          pytest tests/integration/real_execution/test_multi_provider_execution.py \
            -v \
            -m "real_execution" \
            --timeout=300 \
            -k "zai"

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [ollama-tests, deepseek-tests, xai-tests, mistral-tests, openai-tests, zai-tests]
    if: always()  # Run even if previous jobs failed

    steps:
      - name: Display test results
        run: |
          echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ollama Tests" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.ollama-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DeepSeek Tests" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.deepseek-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### xAI Tests" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.xai-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Mistral Tests" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.mistral-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OpenAI Tests" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.openai-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ZAI Tests" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.zai-tests.result }}" >> $GITHUB_STEP_SUMMARY
