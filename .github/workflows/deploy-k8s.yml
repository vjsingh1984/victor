# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Deploy to Kubernetes

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      cluster:
        description: 'Kubernetes cluster context'
        required: true
        type: choice
        options:
          - staging-cluster
          - production-cluster

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.inputs.environment }}
  cancel-in-progress: true

jobs:
  deploy-helm:
    name: Deploy via Helm
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.inputs.environment || 'staging' }}
      url: https://${{ github.inputs.environment == 'production' && 'victor.example.com' || 'staging.victor.example.com' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "Configuring kubectl for ${{ inputs.cluster || 'staging-cluster' }}"
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Get version
        id: version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create namespace
        run: |
          kubectl create namespace victor --dry-run=client -o yaml | kubectl apply -f -

      - name: Create secrets
        run: |
          kubectl create secret generic victor-secrets \
            --from-literal=anthropic-api-key="${{ secrets.ANTHROPIC_API_KEY }}" \
            --from-literal=openai-api-key="${{ secrets.OPENAI_API_KEY }}" \
            --from-literal=google-api-key="${{ secrets.GOOGLE_API_KEY }}" \
            --namespace=victor \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy via Helm
        run: |
          HELM_ARGS="--namespace victor"

          if [ "${{ github.inputs.environment }}" == "production" ]; then
            HELM_ARGS="$HELM_ARGS --set config.environment=production"
            HELM_ARGS="$HELM_ARGS --set replicaCount=3"
            HELM_ARGS="$HELM_ARGS --set autoscaling.enabled=true"
            HELM_ARGS="$HELM_ARGS --set ingress.enabled=true"
            HELM_ARGS="$HELM_ARGS --set ingress.hosts[0].host=victor.example.com"
          else
            HELM_ARGS="$HELM_ARGS --set config.environment=development"
            HELM_ARGS="$HELM_ARGS --set replicaCount=1"
            HELM_ARGS="$HELM_ARGS --set autoscaling.enabled=false"
          fi

          helm upgrade --install victor ./config/helm/victor \
            --set image.tag="${{ steps.version.outputs.version }}" \
            $HELM_ARGS

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/victor-api -n victor --timeout=5m

      - name: Verify deployment
        run: |
          echo "# Kubernetes Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get pod status
          echo "## Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n victor >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Get service status
          echo "## Services" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n victor >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Health check
          echo "## Health Check" >> $GITHUB_STEP_SUMMARY
          kubectl wait --for=condition=ready pod -l app=victor-api -n victor --timeout=60s
          echo "✅ All pods are healthy" >> $GITHUB_STEP_SUMMARY

      - name: Run smoke tests
        run: |
          # Port forward to test API
          kubectl port-forward svc/victor-api 8000:80 -n victor &
          PF_PID=$!
          sleep 5

          # Run health check
          curl -f http://localhost:8000/health/live || exit 1
          curl -f http://localhost:8000/health/ready || exit 1

          # Cleanup
          kill $PF_PID

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          helm rollback victor -n victor

  deploy-manifests:
    name: Deploy via K8s Manifests
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Apply manifests
        run: |
          kubectl apply -f config/k8s/namespace.yaml
          kubectl apply -f config/k8s/configmap.yaml
          kubectl apply -f config/k8s/secret.yaml
          kubectl apply -f config/k8s/serviceaccount.yaml
          kubectl apply -f config/k8s/pvc.yaml
          kubectl apply -f config/k8s/deployment.yaml
          kubectl apply -f config/k8s/service.yaml
          kubectl apply -f config/k8s/ingress.yaml
          kubectl apply -f config/k8s/hpa.yaml
          kubectl apply -f config/k8s/pdb.yaml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/victor-api -n victor --timeout=5m

      - name: Verify deployment
        run: |
          kubectl get all -n victor

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-helm, deploy-manifests]
    if: always()

    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy-helm.result }}" == "success" ]; then
            echo "✅ Deployment successful!"
            # Add Slack/Email notification logic here
          else
            echo "❌ Deployment failed!"
            # Add failure notification logic here
          fi
