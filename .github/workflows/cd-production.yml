# Copyright 2025 Vijaykumar Singh <singhvjd@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: CD - Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (default: from pyproject.toml)'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.inputs.environment }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Get version
  # ==========================================================================
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml'))['project']['version'])")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  # ==========================================================================
  # Run tests (optional skip)
  # ==========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    needs: get-version
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/unit -v \
            --cov=victor \
            --cov-report=xml \
            --cov-fail-under=70

      - name: Run smoke tests
        run: |
          pytest tests/smoke -v

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ==========================================================================
  # Build and push Docker image
  # ==========================================================================
  build-image:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [get-version, test]
    outputs:
      image: ${{ steps.meta.outputs.tags }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.get-version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.get-version.outputs.version }}
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=${{ inputs.environment || 'staging' }}
          labels: |
            org.opencontainers.image.title=Victor AI
            org.opencontainers.image.description=Enterprise AI Coding Assistant
            org.opencontainers.image.version=${{ needs.get-version.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.production
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.get-version.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          probes: true

      - name: Image digest
        run: echo "Digest ${{ steps.build.outputs.digest }}"

  # ==========================================================================
  # Security scan image
  # ==========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'docker-image'

  # ==========================================================================
  # Deploy to Staging
  # ==========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [get-version, build-image, security-scan]
    if: ${{ github.ref == 'refs/heads/main' || inputs.environment == 'staging' }}
    environment:
      name: staging
      url: https://staging.victor.example.com
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config

      - name: Update deployment image
        run: |
          kubectl set image deployment/victor-api \
            victor-api=${{ needs.build-image.outputs.image }} \
            -n victor \
            --record

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/victor-api -n victor --timeout=5m

      - name: Verify deployment
        run: |
          # Check pod status
          kubectl get pods -n victor -l app=victor-api

          # Port-forward and test health endpoint
          kubectl port-forward -n victor svc/victor-api 8000:80 &
          PF_PID=$!
          sleep 10

          # Health checks
          curl -f http://localhost:8000/health/live || exit 1
          curl -f http://localhost:8000/health/ready || exit 1

          # Cleanup
          kill $PF_PID

      - name: Run smoke tests
        run: |
          if [ -f scripts/ci/smoke_test.sh ]; then
            bash scripts/ci/smoke_test.sh staging
          fi

      - name: Deployment summary
        run: |
          cat > staging-deployment.md << 'EOF'
          # Staging Deployment Complete

          **Version**: ${{ needs.get-version.outputs.version }}
          **Image**: ${{ needs.build-image.outputs.image }}
          **Digest**: ${{ needs.build-image.outputs.digest }}
          **Commit**: ${{ github.sha }}

          ## Verification

          ✓ Image built and pushed
          ✓ Security scan passed
          ✓ Deployment rolled out
          ✓ Health checks passed
          ✓ Smoke tests passed

          ## Access

          - URL: https://staging.victor.example.com
          - Namespace: victor
          - Replicas: $(kubectl get deployment victor-api -n victor -o jsonpath='{.spec.replicas}')

          ## Logs

          View logs:
          ```bash
          kubectl logs -f deployment/victor-api -n victor
          ```
          EOF

          cat staging-deployment.md

      - name: Upload deployment summary
        uses: actions/upload-artifact@v4
        with:
          name: staging-deployment
          path: staging-deployment.md

  # ==========================================================================
  # Deploy to Production
  # ==========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [get-version, build-image, security-scan, deploy-staging]
    if: ${{ github.ref == 'refs/heads/main' && inputs.environment == 'production' }}
    environment:
      name: production
      url: https://victor.example.com
    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config

      - name: Create backup before deployment
        run: |
          # Get current image
          CURRENT_IMAGE=$(kubectl get deployment victor-api -n victor -o jsonpath='{.spec.template.spec.containers[0].image}')
          echo "CURRENT_IMAGE=$CURRENT_IMAGE" >> $GITHUB_ENV

          # Save current config
          kubectl get deployment victor-api -n victor -o yaml > victor-api-backup.yaml

      - name: Update deployment image
        run: |
          kubectl set image deployment/victor-api \
            victor-api=${{ needs.build-image.outputs.image }} \
            -n victor \
            --record

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/victor-api -n victor --timeout=10m

      - name: Verify deployment
        run: |
          # Check pod status
          kubectl get pods -n victor -l app=victor-api

          # Port-forward and test
          kubectl port-forward -n victor svc/victor-api 8000:80 &
          PF_PID=$!
          sleep 10

          # Health checks
          curl -f http://localhost:8000/health/live || exit 1
          curl -f http://localhost:8000/health/ready || exit 1

          # Cleanup
          kill $PF_PID

      - name: Run smoke tests
        run: |
          if [ -f scripts/ci/smoke_test.sh ]; then
            bash scripts/ci/smoke_test.sh production
          fi

      - name: Load test (optional)
        run: |
          # Run basic load test
          if command -v locust &> /dev/null; then
            echo "Running load test..."
            # Add your load test commands here
          else
            echo "Locust not installed, skipping load test"
          fi
        continue-on-error: true

      - name: Create GitHub Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ## Victor AI ${{ needs.get-version.outputs.version }}

            **Image**: `${{ needs.build-image.outputs.image }}`
            **Digest**: `${{ needs.build-image.outputs.digest }}`

            ### Installation

            ```bash
            docker pull victor:${{ needs.get-version.outputs.version }}
            ```

            ### Deployment

            ```bash
            kubectl set image deployment/victor-api \
              victor-api=victor:${{ needs.get-version.outputs.version }} \
              -n victor
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back to $CURRENT_IMAGE"
          kubectl rollout undo deployment/victor-api -n victor

          # Wait for rollback
          kubectl rollout status deployment/victor-api -n victor --timeout=5m

      - name: Deployment summary
        if: success()
        run: |
          cat > production-deployment.md << 'EOF'
          # Production Deployment Complete

          **Version**: ${{ needs.get-version.outputs.version }}
          **Image**: ${{ needs.build-image.outputs.image }}
          **Digest**: ${{ needs.build-image.outputs.digest }}
          **Commit**: ${{ github.sha }}
          **Previous Image**: ${{ env.CURRENT_IMAGE }}

          ## Verification

          ✓ Image built and pushed
          ✓ Security scan passed
          ✓ Staging deployment successful
          ✓ Production deployment rolled out
          ✓ Health checks passed
          ✓ Smoke tests passed

          ## Access

          - URL: https://victor.example.com
          - Namespace: victor
          - Replicas: $(kubectl get deployment victor-api -n victor -o jsonpath='{.spec.replicas}')

          ## Monitoring

          - Metrics: http://prometheus.victor.example.com
          - Dashboards: http://grafana.victor.example.com
          - Logs: kubectl logs -f deployment/victor-api -n victor

          ## Rollback (if needed)

          ```bash
          kubectl rollout undo deployment/victor-api -n victor
          ```
          EOF

          cat production-deployment.md

      - name: Upload deployment summary
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment
          path: production-deployment.md

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Production deployment successful"
            # Add Slack/Email notification here
          else
            echo "❌ Production deployment failed"
            # Add failure notification here
          fi

  # ==========================================================================
  # Deployment Report
  # ==========================================================================
  report:
    name: Deployment Report
    runs-on: ubuntu-latest
    if: always()
    needs: [get-version, build-image, security-scan, deploy-staging, deploy-production]
    steps:
      - name: Generate report
        run: |
          cat > deployment-report.md << 'EOF'
          # Production Deployment Report

          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Triggered by**: ${{ github.actor }}
          **Version**: ${{ needs.get-version.outputs.version }}

          ## Job Status

          - Get Version: ${{ needs.get-version.result }}
          - Build Image: ${{ needs.build-image.result }}
          - Security Scan: ${{ needs.security-scan.result }}
          - Deploy Staging: ${{ needs.deploy-staging.result }}
          - Deploy Production: ${{ needs.deploy-production.result }}

          ## Artifacts

          - Docker Image: ${{ needs.build-image.outputs.image }}
          - Image Digest: ${{ needs.build-image.outputs.digest }}
          - GitHub Release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.get-version.outputs.version }}

          ## Links

          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - [Changes](${{ github.server_url }}/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          EOF

          cat deployment-report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md

      - name: Add to job summary
        run: cat deployment-report.md >> $GITHUB_STEP_SUMMARY
